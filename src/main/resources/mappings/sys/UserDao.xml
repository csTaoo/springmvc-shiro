<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shitao.sys.dao.UserDao">
	<select id="getUserByName" parameterType="java.lang.String"
		resultType="com.shitao.sys.entity.User">

		SELECT
		id,
		username NAME,
		PASSWORD,
		realname,
		status
		FROM
		sys_user
		WHERE
		username = #{username}

	</select>

	<insert id="registerUser" parameterType="com.shitao.sys.entity.User">

		INSERT INTO
		sys_user(id,username,password,realname) VALUES
		(#{id},#{name},#{password},#{realname})
	</insert>


	<!-- 获取所有用户 -->
	<select id="getAllUser" resultType="com.shitao.sys.entity.User">
		SELECT
		id,
		username NAME,
		realname,
		status
		FROM
		sys_user
	</select>

	<!-- 根据id获取用户 -->
	<select id="get" parameterType="string" resultMap="userRolePermission">
		SELECT
		u.id,
		u.username name,
		u.realname,
		u.status,
		r.id role_id,
		r.name role_name,
		p.id p_id,
		p.category p_name
		FROM
		sys_user u
		LEFT JOIN sys_user_role ur
		ON u.id =
		ur.user_id
		LEFT JOIN sys_role r
		ON ur.role_id = r.id
		LEFT JOIN
		sys_role_permission rp
		ON r.id = rp.role_id
		LEFT JOIN sys_permission p
		ON rp.p_id = p.id
		WHERE u.id = #{id}
	</select>


	<!-- 用户结果匹配包含角色 权限 -->
	<resultMap type="com.shitao.sys.entity.User" id="userRolePermission">
		<id column="id" property="id" />
		<result column="name" property="name" />
		<result column="realname" property="realname" />
		<result column="status" property="status" javaType="short"/>
		<association property="role" javaType="com.shitao.sys.entity.Role">
			<id column="role_id" property="id" />
			<result column="role_name" property="name" />
			<collection property="permissions" ofType="com.shitao.sys.entity.Permission">
				<id column="p_id" property="id" />
				<result column="p_name" property="name" />
			</collection>
		</association>
	</resultMap>

	<!-- 更新用户信息 -->
	<update id="update">
		UPDATE sys_user SET
		realname=#{realname},
		STATUS=#{status} WHERE
		id=#{id}
	</update>

	<!-- 更新用户角色 -->
	<update id="updateUserRole">
		UPDATE sys_user_role SET
		role_id=#{roleid}
		WHERE
		user_id=#{userid}
	</update>
</mapper>